<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />

        <title> OAuth2 Callback </title>

        <!-- Bootstrap Core CSS -->
        <link href="/3rdparty/sb-admin-2/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/3rdparty/sb-admin-2/css/sb-admin-2.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="/3rdparty/sb-admin-2/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

        <script src="/node_modules/superagent/superagent.js"></script>

        <script>

        function requestAccessToken(clientId) {
            var data = {
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: window.location.origin,
                client_id: clientId,
                client_secret: 'unused'
            };

            superagent.post('http://localhost:5454/api/v1/oauth/token?response_type=token&client_id=' + data.client_id).send(data).end(function (error, result) {
                if (error) return console.error(error);
                if (result.status !== 200) {
                    console.error('Failed to get access token: %s - %s', result.status, result.text);
                    document.getElementById('accessToken').innerHTML = 'ERROR: ' + result.status + ' - ' + result.text;
                    return;
                }

                console.log('Successfully got access token.', result.body.access_token);

                document.getElementById('accessToken').innerHTML = result.body.access_token;
            });
        }

        </script>

    </head>

<body>

    <h1> OAuth2 Test Callback </h1>

    AuthCode: <b><span id="authCode"></span></b>

    <br/>
    <br/>

    <h3> Request access token </h3>
    <b>
        For success, this has to be the same client as the auth code was requested for!<br/>
        Each Auth code is only good for one access token!
    </b>

    <br/>
    <br/>

    <button class="btn btn-default" onclick="requestAccessToken('cid-webadmin');">Webadmin</button>
    <button class="btn btn-default" onclick="requestAccessToken('cid-app');">Test App</button>

    <br/>
    <br/>

    AccessToken: <b><span id="accessToken"></span></b>

    <br/>
    <br/>

    <a href="/">Back</a>
</body>

<script>

var authCode = window.location.search.slice('?authCode='.length);

if (!authCode) {
    console.error('No authCode found.');
    document.getElementById('authCode').innerHTML = 'ERROR: failed to get auth code';
} else {
    console.debug('Got authCode as result of OAuth flow.', authCode);
    document.getElementById('authCode').innerHTML = authCode;
}

</script>

</html>
