<!DOCTYPE html>
<html lang="en">
<head>
  <title> Welcome to Yellow Tent </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
</head>

<body>
  <div class="navbar">
    <img width="48px" src="/assets/yellow_tent.png"/>
    <a href="#" class="navbar-brand">Yellow Tent</a>

    <div class="navbar-text pull-right dropdown">
      <a class="navbar-link" data-toggle="dropdown" href="#">
        <span id="user-dropdown-trigger">Signed in as</span>
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
        <li><a tabindex="-1" href="#">Preferences</a></li>
        <li class="divider"></li>
        <li><a tabindex="-1" href="#" id="logout-button">Sign out</a></li>
      </ul>
    </div>  <!-- signed-in dropdown -->
  </div> <!-- navbar -->

  <div class="container">
    <ul class="nav nav-pills nav-justified">
      <li id="home-link"><a href="#home">Home</a></li>
      <li id="devices-link"><a href="#devices">My Devices</a></li>
      <li id="files-link"><a href="#files">Files</a></li>
      <li id="usersgroups-link"><a href="#usersgroups">Users &amp; Groups</a></li>
      <li id="logs-link"><a href="#logs">Logs</a></li>
    </ul>
  </div> <!-- container -->

  <div class="container">
    <div id="home-container" class="container hide">
      Home
    </div>

    <div id="devices-container" class="container hide">
      My Devices
    </div>

    <div id="files-container" class="container hide">
      <h3>Volumes</h3>
      <div id="volume-list-container" class="container">
      </div>
      <h3>Files</h3>
      <div id="file-list-container" class="container">
      </div>
    </div>

    <div id="usersgroups-container" class="container hide">
      Users &amp; Groups
    </div>

    <div id="logs-container" class="container hide">
      Logs
    </div>
  </div>

  <script src="jquery/jquery.js"></script>
  <script src="jquery/jquery.base64.min.js"></script>
  <script src="jquery/jquery.cookie.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <script>

    // should go into files/utils library
    function printableSize(size) {
      var kb = 1024;
      var mb = kb * 1024;
      var gb = mb * 1024;

      if (size < mb) {
        return (size/kb).toPrecision(4) + " KB";
      } else if (size < gb) {
        return (size/mb).toPrecision(4) + " MB";
      } else {
        return (size/gb).toPrecision(4) + " GB";
      }
    }

    function createFileListingDelegate(data) {
      var elem = document.createElement("a");
      elem.classList.add("list-group-item");
      elem.innerText = data.filename + (data.isDirectory ? "/" : "");
      elem.href = "#files";
      elem.onclick = function () {
        if (data.isDirectory) {
          getFileListing(null, data.path);
        }
      }

      var badge = document.createElement("span");
      badge.classList.add("badge");
      badge.innerText = printableSize(data.stat.size);

      elem.appendChild(badge);

      return elem;
    }

    function createVolumeListingDelegate(data) {
      var elem = document.createElement("a");
      elem.classList.add("list-group-item");
      elem.innerText = data.name
      elem.href = "#files";
      elem.onclick = function () {
        getFileListing(data.id);
      }

      return elem;
    }

    function getVolumeListing() {
      var container = document.getElementById("volume-list-container");
      if (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      $.getJSON("/api/v1/volume/list", function (data) {
          var group = document.createElement("ul");
          group.classList.add("list-group");

          data.forEach(function (e) {
            group.appendChild(createVolumeListingDelegate(e));
          });

          container.appendChild(group);
      }).fail(function (error) {
        console.error("Unable to get volume listing", error);
      });
    }

    function getFileListing(volume, folder) {
      volume = volume ? volume : 0;
      folder = folder ? folder : ".";

      var container = document.getElementById("file-list-container");
      if (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      $.getJSON("/api/v1/volume/" + volume + "/list/" + folder, function (data) {
          var group = document.createElement("ul");
          group.classList.add("list-group");

          data.forEach(function (e) {
            group.appendChild(createFileListingDelegate(e));
          });

          container.appendChild(group);
      }).fail(function (error) {
        console.error("Unable to get file listing.", error);
      });
    }

    $(document).ready(function () {
      var token;
      var currentView;


      // check for token to proceed
      token = $.cookie('token');
      if (!token) {
        window.location.replace('index.html');
      }


      // select current view - if window.location.hash is set it already contains the # to reference with jquery
      function updateCurrentView() {
        var view = window.location.hash ? window.location.hash.slice(1) : "home";

        if (currentView === view) {
          return;
        }

        if (currentView) {
          document.getElementById(currentView + "-container").classList.add("hide");
          document.getElementById(currentView + "-link").classList.remove("active");
        }

        currentView = view;
        document.getElementById(currentView + "-container").classList.remove("hide");
        document.getElementById(currentView + "-link").classList.add("active");
      }


      // update view according to the current hash
      updateCurrentView();
      getVolumeListing();


      // get user info to update avatar ui
      $.getJSON('/api/v1/userInfo', function (data) {
          $("#user-dropdown-trigger").text("Signed in as " + data.username);
      }).fail(function(error) {
        console.error('Unable to get username.', error);
          $("#user-dropdown-trigger").text("Invalid user");
      });


      // setup event handler
      window.onhashchange = function hashChangeListener(e) {
        updateCurrentView();
      }


      // setup onclick handler
      $('#logout-button').click(function (event) {
        $.get('/api/v1/logout', function (data) {}).always(function() {
          $.removeCookie('token');
          window.location.href = "index.html";
        });
      });
    });
  </script>

</body>

</html>
