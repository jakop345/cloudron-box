<!DOCTYPE html>
<html lang="en">
<head>
  <title> Yellow Tent Login </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    var ajax = new XMLHttpRequest();
    ajax.onreadystatechange = function () {
      if (ajax.readyState === 4) {
        if (ajax.status == 200) {
          if (JSON.parse(ajax.responseText).firstTime)
              window.location.assign('firsttime.html');
        }
      }
    }
    ajax.open('GET', '/api/v1/firstTime', false /* async */);
    ajax.send();
  </script>
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <style>
    .container {
        margin-top: 100px;
        width: 40%;
        margin-left: 30%;
    }
  </style>
</head>

<body>
  <div class="navbar">
    <img width="48px" src="/assets/yellow_tent.png"/>
    <a href="#" class="navbar-brand">Yellow Tent</a>
  </div>

  <div class="container">
    <div class="panel">
      <div class="panel-heading">
        <h4 class="panel-title">Login</h4>
      </div>
      <div class="panel-content">
        <form id="loginForm" class="form-horizontal">
          <div class="form-group">
            <label for="username" class="col-lg-2 control-label">Username</label>
            <div class="col-lg-10">
              <input type="text" class="form-control" id="username" placeholder="Username" name="username">
            </div>
          </div>
          <div class="form-group">
            <label for="password" class="col-lg-2 control-label">Password</label>
            <div class="col-lg-10">
              <input type="password" class="form-control" id="password" placeholder="Password" name="password">
              <div class="checkbox">
                <label>
                  <input type="checkbox"> Remember me
                </label>
              </div>
              <button type="submit" class="btn btn-default btn-primary">Login</button>
            </div>
          </div>
        </form>
      </div> <!-- panel-content -->
    </div> <!-- panel -->
  </div> <!-- container -->

  <div id="modalDialog" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Title</h4>
        </div>
        <div class="modal-body">
          <p>Body</p>
          <div class="progress progress-striped active">
            <div class="progress-bar" style="width: 100%"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="button1" class="btn btn-default btn-primary" data-dismiss="modal">OK</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script src="jquery/jquery.js"></script>
  <script src="jquery/jquery.base64.min.js"></script>
  <script src="jquery/jquery.cookie.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <script>
    function showModalDialog(header, body, options) {
        options = options || { okButton: true };
        $('#modalDialog .modal-title').text(header);
        $('#modalDialog .modal-body p').text(body);
        if (options.okButton) {
          $('#modalDialog .modal-footer').show();
          $('#modalDialog button.close').show();
          $('#modalDialog .progress').hide();
          $('#modalDialog button#button1').text('OK');
        } else if (options.indeterminate) {
          // FIXME: clicking on the backdrop closes the modal
          $('#modalDialog .modal-footer').hide();
          $('#modalDialog button.close').hide();
          $('#modalDialog .progress').show();
        }
        $('#modalDialog').modal('show');
    }

    function hideModalDialog() {
        $('#modalDialog').modal('hide');
    }

    function errorHandler(context) {
      return function (xhr, textStatus, errorThrown) {
        showModalDialog(context, ' status:' + textStatus + ' error:' + errorThrown);
      }
    }

    function auth(username, password) {
        return $.base64.encode(username + ':' + password);
    }

    function getToken(username, password) {
      $.ajax({
        type: 'POST',
        url: '/api/v1/token',
        beforeSend: function (xhr) {
          xhr.setRequestHeader('Authorization', auth(username, password));
        },
        dataType: 'json',
        success: function (data) {
          hideModalDialog();
          $.cookie('token', data.token);
          window.location.replace('dashboard.html');
        },
        error: errorHandler('Token creation failed. Incorrect username or password?')
      });
    }

    $('#loginForm').submit(function (event) {
      event.preventDefault();
      var $form = $(this),
          username = $form.find('input[name="username"]').val(),
          password = $form.find('input[name="password"]').val();

        showModalDialog('Logging in', 'please wait', { indeterminate: true });
        getToken(username, password);
    });

    $(document).ready(function () {
      $('form:first *:input[type!=hidden]:first').focus();
    });
  </script>
</body>

</html>
